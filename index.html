<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8" />
    <!-- Titel von "Sternenfahrer Demo" zu etwas Produktionsreifem ge√§ndert -->
    <title>Sternenfahrer</title>

    <!-- Orbitron-Font (nur kosmetisch) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">

    <!-- Vue.js (CDN) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <style>
        /* =========== GLOBAL STYLES =========== */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', sans-serif;
            background: linear-gradient(to bottom right, #1e1e1e 60%, #3f2d2d);
            color: #f0e6d2;
            line-height: 1.5;
            font-size: 1.1rem;
        }

        /* 
          #app wird skaliert. transform-origin auf "top left",
          damit wir um die linke obere Ecke herum vergr√∂√üern/verkleinern.
        */
        #app {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            transform-origin: top left;
            /* #CHANGED: f√ºr UI-Scaling */
        }

        /* =========== TOP-BAR =========== */
        .top-bar {
            border-bottom: 2px solid #ff9800;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .player-badge {
            display: inline-flex;
            align-items: center;
            background: #333;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .player-badge:hover {
            background: #444;
        }

        .color-box {
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border: 1px solid #bbb;
        }

        /* =========== HEADLINE / BUTTONS =========== */
        h1 {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            font-size: 2.2rem;
            text-align: center;
            color: #ffa000;
        }

        @media(max-width:600px) {
            h1 {
                font-size: 1.7rem;
            }
        }

        button {
            background: #ff9800;
            border: none;
            padding: 0.8rem 1.4rem;
            border-radius: 6px;
            color: #1e1e1e;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: background 0.3s;
        }

        button:hover {
            background: #ffa726;
        }

        .adjust-btn {
            font-size: 1.3rem;
            margin: 0 0.3rem;
            display: inline-block;
            width: 2.8rem;
            text-align: center;
        }

        /* =========== PLAYER-BOX =========== */
        .player-box {
            background: rgba(50, 50, 50, 0.4);
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 1px solid #444;
        }

        hr {
            border: none;
            border-top: 1px solid #777;
            margin: 1rem 0;
        }

        h2,
        h3 {
            color: #ffd54f;
            margin-top: 0.5rem;
        }

        /* =========== MARBLES (Kugeln) =========== */
        .marble-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 4px;
            vertical-align: middle;
            border: 3px solid #fff;
            /* dicker Rand */
        }

        /*
          Overlay-Kugeln gleiche Gr√∂√üe
        */
        .overlayWurf .marble-circle {
            width: 20px;
            height: 20px;
            margin-left: 4px;
            vertical-align: middle;
            border: 3px solid #fff;
        }

        .mini-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        /* Farbklassen */
        .rot {
            background: red;
        }

        .blau {
            background: blue;
        }

        .gelb {
            background: yellow;
        }

        .gruen {
            background: green;
        }

        .schwarz {
            background: #555;
        }

        /* =========== OVERLAY =========== */
        .overlayWurf {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            z-index: 9999;
            width: 360px;
            max-width: 90%;
            box-shadow: 0 0 12px rgba(0, 0, 0, 0.7);
            font-size: 1.3rem;
            line-height: 1.5;
        }

        .overlayWurf h2 {
            margin: 0 0 1rem;
            font-size: 1.8rem;
            color: #ffca28;
        }

        .overlayWurf p {
            margin: 0.8rem 0;
        }

        @media(max-width:600px) {
            .overlayWurf {
                font-size: 1.2rem;
            }

            .overlayWurf h2 {
                font-size: 1.6rem;
            }
        }

        /* =========== RUHMESRINGE =========== */
        .ring-row {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin: 0.3rem 0;
            align-items: center;
        }

        .ring-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #777;
            border: 2px solid #aaa;
        }

        .gold-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ffa726;
            border: 2px solid #fff;
        }

        /* =========== FRIENDSHIP BADGES =========== */
        .friendship-badge {
            margin-left: 6px;
            font-size: 1rem;
            opacity: 0.85;
        }

        /* 
          #CHANGED: Servernachricht unten zentriert
          (gew√ºnscht: unten mittig platziert)
        */
        .status-message {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            text-align: center;
            z-index: 10000;
            /* √ºber allen anderen Elementen */
        }
    </style>
</head>

<body>
    <div id="app">

        <!-- 
            Overlay: Titel angepasst von "Wurf (Snippet)" zu etwas neutralerem/prod-reifem 
            #CHANGED
        -->
        <div class="overlayWurf" v-if="showWurfOverlay">
            <h2>Aktueller Wurf</h2>
            <!-- Mini-Badge f√ºr Kugeln -->
            <div class="mini-badge">
                <span v-for="(m,i) in overlayMarbles" :key="i" class="marble-circle" :class="m"></span>
            </div>
            <p>Grundgeschwindigkeit: {{ overlayWurfData.baseSpeed }}</p>
            <p>
                + Ausbauten ({{ overlayWurfData.antriebe }} Antriebe)
                <span v-if="overlayWurfData.friendshipAntrieb>0">
                    + {{ overlayWurfData.friendshipAntrieb }} (Karten)
                </span>
            </p>
            <p><strong>Gesamt: {{ overlayWurfData.finalSpeed }}</strong></p>
        </div>

        <!-- Top-Bar (alle Spieler) -->
        <div class="top-bar">
            <!-- Badge pro Spieler; Klick w√§hlt Spieler aus -->
            <span v-for="(pObj, pId) in players" :key="pId" class="player-badge" @click="selectPlayer(pId)">
                <span class="color-box" :style="{ backgroundColor: pObj.color }"></span>
                {{ pObj.name }}

                <!-- Letzter Wurf in Mini-Form (oben in der Leiste) -->
                <template v-if="pObj.letzter_wurf && pObj.letzter_wurf.kugeln">
                    <span class="marble-circle" v-for="(mc, idx) in normalizeMarbles(pObj.letzter_wurf.kugeln)"
                        :key="idx" :class="mc"></span>
                </template>

                <!-- Freundschaftskarten-Icons -->
                <span v-if="pObj.friendship.kampf_plus2" class="friendship-badge">‚öîÔ∏è+2</span>
                <span v-if="pObj.friendship.antrieb_plus2" class="friendship-badge">üöÄ+2</span>
                <span v-if="pObj.friendship.combo_plus1" class="friendship-badge">‚öîÔ∏è+üöÄ+1</span>
            </span>
        </div>

        <!-- 
            H1 aktualisiert (keine Demo mehr)
            #CHANGED
        -->
        <h1>Digitales Mutterschiff</h1>

        <!--
            #CHANGED:
            Der bisherige "Status: ..." Text wurde entfernt, 
            damit wir ihn unten anheften (siehe class="status-message" weiter unten).
        -->

        <!-- Falls kein Player ausgew√§hlt ist: neues Spielerformular -->
        <div v-if="!currentPlayerId">
            <!-- Text von "Neuen Spieler anlegen" => "Neuen Spieler hinzuf√ºgen" (o.√Ñ.) -->
            <h3>Neuen Spieler hinzuf√ºgen</h3>
            <div class="label-line">
                <strong>Name:</strong><br>
                <input v-model="newPlayerName" placeholder="Name" style="font-size:1.1rem;">
            </div>
            <div class="label-line">
                <strong>Farbe:</strong><br>
                <select v-model="newPlayerColor" style="font-size:1.1rem;">
                    <option disabled value="">(Farbe w√§hlen)</option>
                    <option v-for="c in colorOptions" :value="c" :disabled="usedColors.includes(c)">
                        {{ c }}
                    </option>
                </select>
            </div>
            <button @click="createPlayer" style="font-size:1.1rem;">
                Spieler erstellen
            </button>
            <p style="margin-top:0.5rem;">
                W√§hle stattdessen oben einen Spieler aus, um ihn zu verwalten.
            </p>
        </div>

        <!-- Player-Details, wenn currentPlayerId gesetzt -->
        <div v-else>
            <!--
                #CHANGED:
                Anstatt "Hallo {{ currentPlayerName }} ({{ currentPlayerColor }})"
                => "Spieler: <span :style="{color:currentPlayerColor}">Name</span>"
            -->
            <h2>
                Spieler:
                <span :style="{ color: currentPlayerColor }">
                    {{ currentPlayerName }}
                </span>
            </h2>

            <div class="player-box">
                <h3>Ausbauten</h3>
                <div class="label-line">
                    <strong>Antriebe (max.6)</strong><br>
                    <button class="adjust-btn" @click="incrementAntriebe(-1)">-</button>
                    <span>{{ myPlayer.antriebe }}</span>
                    <button class="adjust-btn" @click="incrementAntriebe(+1)">+</button>
                </div>
                <div class="label-line">
                    <strong>Bordkanone (max.6)</strong><br>
                    <button class="adjust-btn" @click="incrementKanonen(-1)">-</button>
                    <span>{{ myPlayer.bordkanonen }}</span>
                    <button class="adjust-btn" @click="incrementKanonen(+1)">+</button>
                </div>
                <div class="label-line">
                    <strong>Frachtmodul (max.5)</strong><br>
                    <button class="adjust-btn" @click="incrementFracht(-1)">-</button>
                    <span>{{ myPlayer.frachtmodule }}</span>
                    <button class="adjust-btn" @click="incrementFracht(+1)">+</button>
                </div>

                <hr>
                <h3>Ruhmesringe</h3>
                <div class="label-line">
                    <button class="adjust-btn" @click="changeMedaillen(-1)">-</button>
                    <span>{{ myPlayer.ruhmesringe }}</span>
                    <button class="adjust-btn" @click="changeMedaillen(+1)">+</button>
                </div>
                <!-- Ringe in Grau -->
                <div class="ring-row">
                    <span v-for="r in myPlayer.ruhmesringe" :key="r+'-'+Math.random()" class="ring-circle"></span>
                </div>
                <div class="label-line"><strong>Siegpunkte:</strong></div>
                <!-- Goldene Kreise je 2 Ringe -->
                <div class="ring-row">
                    <span v-for="s in ringPoints" :key="'sp'+s" class="gold-circle"></span>
                </div>

                <hr>
                <h3>Freundschaftskarten</h3>
                <p style="margin-bottom:0.3rem;">Aktiviere/Deaktiviere deine Boni:</p>
                <label>
                    <input type="checkbox" v-model="myPlayer.friendship.kampf_plus2"
                        @change="toggleFriendship('kampf_plus2')">
                    ‚öîÔ∏è+2 Kampfkraft
                </label><br>
                <label>
                    <input type="checkbox" v-model="myPlayer.friendship.antrieb_plus2"
                        @change="toggleFriendship('antrieb_plus2')">
                    üöÄ+2 Antrieb
                </label><br>
                <label>
                    <input type="checkbox" v-model="myPlayer.friendship.combo_plus1"
                        @change="toggleFriendship('combo_plus1')">
                    ‚öîÔ∏è+üöÄ +1
                </label>

                <hr>
                <h3>Wurf</h3>

                <div v-if="myPlayer.letzter_wurf">
                    <p>Letzter Wurf:</p>
                    <div class="mini-badge">
                        <span class="marble-circle" v-for="(mc,idx) in normalizeMarbles(myPlayer.letzter_wurf.kugeln)"
                            :key="idx" :class="mc">
                        </span>
                    </div>
                    <p>Grund: {{ myPlayer.letzter_wurf.grundgeschwindigkeit }}</p>
                    <p>
                        Ausbauten (Antriebe): {{ myPlayer.antriebe }}
                        <span v-if="friendshipAntrieb > 0">+ {{ friendshipAntrieb }} (Karten)</span>
                    </p>
                    <p>Gesamt-Flugweite: {{ lastWurfTotalSpeed }}</p>
                </div>
                <div v-else>
                    <em>Kein Wurf</em>
                </div>
                <button @click="doWurf" style="font-size:1.1rem;">
                    Wurf ausf√ºhren
                </button>
            </div>

            <!-- 
                #CHANGED:
                Oben √ºber "Diesen Spieler l√∂schen" und "Spiel zur√ºcksetzen" 
                zwei Buttons zum √Ñndern des UI-Scale (gew√ºnscht).
            -->
            <div style="text-align:center; margin-top:1rem;">
                <button @click="scaleDown" style="background:#ffc107; font-size:1.1rem;">
                    UI verkleinern
                </button>
                <button @click="scaleUp" style="background:#ffc107; font-size:1.1rem;">
                    UI vergr√∂√üern
                </button>
            </div>

            <!-- Buttons unten (L√∂schen / Spiel zur√ºcksetzen) -->
            <div style="text-align:center; margin-top:1rem;">
                <button @click="deleteMe" style="background:#e53935; font-size:1.1rem;">
                    Diesen Spieler l√∂schen
                </button>
                <button @click="resetGame" style="background:#888; font-size:1.1rem;">
                    Spiel zur√ºcksetzen
                </button>
            </div>


            <!-- Servernachricht unten mittig (als "Pseudo-Button") -->
            <div style="text-align:center;margin-top:1rem;">
                <button style="background:#555; color:#fff; cursor:default;">
                    {{ statusMessage }}
                </button>
            </div>
        </div>
    </div>
    </div>



    <script>
        // Mapping zur Normalisierung eingehender Kugelnamen
        const MARBLE_MAP = {
            "rot": "rot", "Rot": "rot",
            "blau": "blau", "Blau": "blau",
            "gelb": "gelb", "Gelb": "gelb",
            "schwarz": "schwarz", "Schwarz": "schwarz",
            "gruen": "gruen", "Gr√ºn": "gruen"
        };

        Vue.createApp({
            data() {
                return {
                    statusMessage: "Verbinde ...",
                    ws: null,
                    gameState: { players: {} },
                    currentPlayerId: null,
                    newPlayerName: "",
                    newPlayerColor: "",
                    colorOptions: ["red", "blue", "green", "yellow", "black", "white"],
                    showWurfOverlay: false,
                    overlayWurfData: {
                        playerName: "",
                        kugeln: [],
                        baseSpeed: 0,
                        antriebe: 0,
                        friendshipAntrieb: 0,
                        finalSpeed: 0
                    },

                    // #CHANGED: UI-Skalierungsfaktor
                    uiScale: 1
                };
            },
            computed: {
                players() {
                    return this.gameState.players || {};
                },
                usedColors() {
                    const arr = [];
                    for (const pid in this.players) {
                        arr.push(this.players[pid].color);
                    }
                    return arr;
                },
                myPlayer() {
                    if (!this.currentPlayerId) return {};
                    return this.players[this.currentPlayerId] || {};
                },
                currentPlayerName() {
                    return this.myPlayer.name || "";
                },
                currentPlayerColor() {
                    return this.myPlayer.color || "";
                },
                friendshipAntrieb() {
                    let sum = 0;
                    if (this.myPlayer.friendship) {
                        if (this.myPlayer.friendship.antrieb_plus2) sum += 2;
                        if (this.myPlayer.friendship.combo_plus1) sum += 1;
                    }
                    return sum;
                },
                lastWurfTotalSpeed() {
                    if (!this.myPlayer.letzter_wurf) return 0;
                    const g = this.myPlayer.letzter_wurf.grundgeschwindigkeit || 0;
                    return g + (this.myPlayer.antriebe || 0) + this.friendshipAntrieb;
                },
                ringPoints() {
                    const rr = this.myPlayer.ruhmesringe || 0;
                    const sp = Math.floor(rr / 2);
                    let arr = [];
                    for (let i = 0; i < sp; i++) {
                        arr.push(i);
                    }
                    return arr;
                },
                overlayMarbles() {
                    return this.normalizeMarbles(this.overlayWurfData.kugeln);
                }
            },
            methods: {
                normalizeMarbles(kugelnArr) {
                    if (!kugelnArr) return [];
                    return kugelnArr.map(k => {
                        let clean = (k || "").trim();
                        if (MARBLE_MAP[clean]) {
                            clean = MARBLE_MAP[clean];
                        }
                        return clean;
                    });
                },
                connectWS() {
                    this.ws = new WebSocket(`ws://${location.hostname}:8765/`);

                    this.ws.onopen = () => {
                        this.statusMessage = "WebSocket verbunden.";
                    };
                    this.ws.onclose = () => {
                        this.statusMessage = "Verbindung weg, Reconnect in 3s...";
                        setTimeout(() => this.connectWS(), 3000);
                    };
                    this.ws.onerror = (e) => {
                        console.error("WS-Error:", e);
                    };

                    this.ws.onmessage = (evt) => {
                        const data = JSON.parse(evt.data);
                        console.log("[DEBUG] new message:", data);
                        if (data.type === "GAME_STATE") {
                            let oldPlayers = this.gameState.players || {};
                            this.gameState = data.payload;

                            // Falls bei unserem aktuellen Spieler ein neuer Wurf kam => Overlay
                            if (this.currentPlayerId) {
                                let oldWurf = oldPlayers[this.currentPlayerId]?.letzter_wurf;
                                let newWurf = this.myPlayer.letzter_wurf;

                                if (newWurf && (
                                    !oldWurf
                                    || JSON.stringify(oldWurf.kugeln) !== JSON.stringify(newWurf.kugeln)
                                    || oldWurf.grundgeschwindigkeit !== newWurf.grundgeschwindigkeit
                                )) {
                                    this.showRollOverlay(newWurf);
                                }
                            }
                        }
                    };
                },
                sendAction(action, data) {
                    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                        this.statusMessage = "WS nicht offen.";
                        return;
                    }
                    this.ws.send(JSON.stringify({ action, data }));
                },
                createPlayer() {
                    if (!this.newPlayerName) {
                        alert("Name fehlt!");
                        return;
                    }
                    if (!this.newPlayerColor) {
                        alert("Farbe fehlt!");
                        return;
                    }
                    if (this.usedColors.includes(this.newPlayerColor)) {
                        alert("Farbe schon belegt!");
                        return;
                    }
                    this.sendAction("createPlayer", {
                        name: this.newPlayerName,
                        color: this.newPlayerColor
                    });
                    // Nach kurzer Zeit den neuesten Player w√§hlen
                    setTimeout(() => {
                        let maxN = 0, newest = null;
                        for (let pid in this.players) {
                            let n = parseInt(pid.slice(1), 10);
                            if (n > maxN) {
                                maxN = n;
                                newest = pid;
                            }
                        }
                        if (newest) {
                            this.currentPlayerId = newest;
                        }
                    }, 500);
                },
                selectPlayer(pid) {
                    this.currentPlayerId = pid;
                },
                deleteMe() {
                    if (!this.currentPlayerId) return;
                    const sure = confirm("Diesen Spieler l√∂schen?");
                    if (!sure) return;
                    this.sendAction("deletePlayer", { playerId: this.currentPlayerId });
                    this.currentPlayerId = null;
                },
                resetGame() {
                    const sure = confirm("Ganzes Spiel zur√ºcksetzen?");
                    if (!sure) return;
                    this.sendAction("resetGame", {});
                    this.currentPlayerId = null;
                },
                incrementAntriebe(v) {
                    if (!this.currentPlayerId) return;
                    let newVal = (this.myPlayer.antriebe || 0) + v;
                    if (newVal < 0) newVal = 0;
                    if (newVal > 6) newVal = 6;
                    this.myPlayer.antriebe = newVal;
                    this.updateAusbau();
                },
                incrementKanonen(v) {
                    if (!this.currentPlayerId) return;
                    let newVal = (this.myPlayer.bordkanonen || 0) + v;
                    if (newVal < 0) newVal = 0;
                    if (newVal > 6) newVal = 6;
                    this.myPlayer.bordkanonen = newVal;
                    this.updateAusbau();
                },
                incrementFracht(v) {
                    if (!this.currentPlayerId) return;
                    let newVal = (this.myPlayer.frachtmodule || 0) + v;
                    if (newVal < 0) newVal = 0;
                    if (newVal > 5) newVal = 5;
                    this.myPlayer.frachtmodule = newVal;
                    this.updateAusbau();
                },
                updateAusbau() {
                    if (!this.currentPlayerId) return;
                    this.sendAction("updateAusbau", {
                        playerId: this.currentPlayerId,
                        antriebe: this.myPlayer.antriebe,
                        bordkanonen: this.myPlayer.bordkanonen,
                        frachtmodule: this.myPlayer.frachtmodule
                    });
                },
                changeMedaillen(d) {
                    if (!this.currentPlayerId) return;
                    this.sendAction("updateMedaillen", {
                        playerId: this.currentPlayerId,
                        delta: d
                    });
                },
                toggleFriendship(t) {
                    if (!this.currentPlayerId) return;
                    this.sendAction("toggleFriendship", {
                        playerId: this.currentPlayerId,
                        type: t
                    });
                },
                doWurf() {
                    if (!this.currentPlayerId) return;
                    this.sendAction("doWurf", { playerId: this.currentPlayerId });
                },
                showRollOverlay(newWurf) {
                    let base = newWurf.grundgeschwindigkeit || 0;
                    let a = this.myPlayer.antriebe || 0;
                    let f = 0;
                    if (this.myPlayer.friendship) {
                        f += this.myPlayer.friendship.antrieb_plus2 ? 2 : 0;
                        f += this.myPlayer.friendship.combo_plus1 ? 1 : 0;
                    }
                    let total = base + a + f;

                    this.overlayWurfData.kugeln = newWurf.kugeln || [];
                    this.overlayWurfData.baseSpeed = base;
                    this.overlayWurfData.antriebe = a;
                    this.overlayWurfData.friendshipAntrieb = f;
                    this.overlayWurfData.finalSpeed = total;

                    this.showWurfOverlay = true;
                    // Nach 5s Overlay ausblenden
                    setTimeout(() => {
                        this.showWurfOverlay = false;
                    }, 5000);
                },

                // #CHANGED: Methoden zum Skalieren des UI
                scaleUp() {
                    this.uiScale += 0.1;
                    this.applyScale();
                },
                scaleDown() {
                    // etwas begrenzen, z.B. nicht unter 0.5
                    this.uiScale = Math.max(0.5, this.uiScale - 0.1);
                    this.applyScale();
                },
                applyScale() {
                    // per JavaScript den transform-Stil auf #app anwenden
                    const appDiv = document.getElementById('app');
                    if (appDiv) {
                        appDiv.style.transform = `scale(${this.uiScale})`;
                    }
                }
            },
            mounted() {
                this.connectWS();
                this.applyScale(); // initialen Scale anwenden
            }
        }).mount("#app");
    </script>
</body>

</html>